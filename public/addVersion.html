<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="scripts/request.js"></script>
    <script type="text/javascript">

      window.loadApp = function() {
        var appId = getQueryParam("id");
        var currentVersionNumber = getQueryParam("currentVersionNumber");

        if (currentVersionNumber !== null) {
          document.getElementById("currentVersionNumber").innerHTML = currentVersionNumber;
        }
      }

      function getQueryParam(name) {
        var query = window.location.search;
        var paramStarts = query.indexOf(name + "=") > 0 ?
          (query.indexOf(name + "=") + name.length + 1) : -1;
        var paramEnds = paramStarts + query.substring(paramStarts).indexOf("&");

        if (paramStarts == -1) {
          return null;
        } else {
          if (paramEnds < paramStarts) {
            return query.substring(paramStarts);
          } else {
            return query.substring(paramStarts, paramEnds);
          }
        }
      }

      window.uploadNewVersion = function() {
        var appId = getQueryParam("id");

        var sessionId = getCookie("sessionId");

        var newVersionNumber = document.getElementById("newVersionNumber").value;
        var newVersionName = document.getElementById("newVersionName").value;

        var newVersionFile = document.getElementById("newVersionFile").files;
        if (newVersionFile.length != 1) {
          alert("Please select a single binary");
        } else if (!newVersionFile[0].name.toLowerCase().endsWith(".apk")) {
          alert("Please select a APK file");
        } else {
          new request("/api/applications/" + appId + "/versions").post([{
            "name": "sessionId",
            "value": sessionId
          }, {
            "name": "versionName",
            "value": newVersionName
          }, {
            "name": "versionNumber",
            "value": newVersionNumber
          }, {
            "name": "binary",
            "value": newVersionFile[0],
            "filename": "binary.apk"
          }], true).then(function(error, status, responseText) {
            if (status == 401) {
              window.location = "login.html";
            } else if (error || status !== 201) {
              alert(JSON.parse(responseText).errors[0].message);
            } else {
              alert("Your application has been updated");
              window.location = "edit.html?id=" + appId;
            }
          });
        }
      }

      function getCookie(name) {
        var cookieValueStarts = document.cookie.indexOf(name + "=") + name.length + 1;
        var cookieValueEnds = document.cookie.substring(cookieValueStarts).indexOf(";");

        if (cookieValueStarts > -1) {
          if (cookieValueEnds > -1) {
            return document.cookie.substring(cookieValueStarts, cookieValueEnds);
          } else {
            return document.cookie.substring(cookieValueStarts);
          }
        } else {
          return null;
        }
      }
    </script>
    <title>sTORe</title>
    <link rel="stylesheet" type="text/css" href="style.css"/>
  </head>
  <body onload="loadApp()">
    <noscript>
      <p>Please enable JavaScript for this page to work correctly.</p>
    </noscript>
    <h1 class="margin-top-10px">Create a new application version:</h1>
    <div>
      <p>Current version number: <span id="currentVersionNumber">none</span></p>
      <br />
      <p>New version number: <input id="newVersionNumber" min="1" required="true" type="text"/></p>
      <p>New version name: <input id="newVersionName" min="1" required="true" type="text"/></p>
      <p>New version binary: <input id="newVersionFile" type="file"/></p>
      <input onclick="uploadNewVersion()" type="button" value="Submit" />
    </div>
  </body>
</html>
